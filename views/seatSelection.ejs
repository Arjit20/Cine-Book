<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seat Selection - <%= movie.title %></title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap">
  <script src="/socket.io/socket.io.js" defer></script>
  <style>
    /* Revamped cinematic styling */
    .cinema-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
      min-height: 100vh;
      color: #e6fbff;
      background: radial-gradient(1200px 600px at 50% -10%, rgba(0,188,212,0.18), transparent 60%), #0e1318;
      transition: transform .5s ease, filter .5s ease;
    }

    .cinema-header { text-align: center; margin-bottom: 18px; }
    .cinema-header h1 { color: #27d0e6; font-size: 2.6rem; margin: 10px 0 6px; letter-spacing: 0.5px; }
    .show-details { font-size: 1.1rem; color: #88f1ff; }
    .seat-limit { font-size: 1rem; color: #ffb84d; margin: 10px 0; }

    /* Curved screen with glow */
    .screen-container { text-align: center; margin: 28px 0 18px; perspective: 1200px; }
    .screen {
      width: min(82%, 920px);
      height: 22px;
      margin: 0 auto;
      background: linear-gradient(90deg, #eafcff, #bdefff);
      border-radius: 50% / 100% 100% 0 0;
      box-shadow: 0 10px 40px rgba(0, 188, 212, 0.45), inset 0 -6px 10px rgba(0,0,0,0.2);
      transform-origin: center bottom;
      transition: transform .6s ease, box-shadow .6s ease, filter .6s ease;
    }

    /* Accessible seating grid (A-H, 10 seats/row) */
    .seating { width:min(820px,100%); margin:26px auto 12px; display:grid; gap:.6rem; transition: transform .6s ease, filter .6s ease; transform-style: preserve-3d; }
    .row { display:grid; grid-template-columns:auto repeat(5,1fr) 18px repeat(5,1fr) auto; align-items:center; gap:.6rem; position:relative; transform-style: preserve-3d; }
    .row::before { content:""; position:absolute; left:28px; right:28px; top:-8px; height:0; border-top:1px solid rgba(255,255,255,.06); border-radius:999px; }
    .row-label { width:28px; text-align:center; color:#bfe9f0; font-size:.85rem; }
    .seat { display:flex; align-items:center; justify-content:center; }
    .sr-only{ position:absolute!important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
    .seat label { cursor:pointer; display:inline-flex; align-items:center; justify-content:center; width:36px; height:32px; border-radius:6px 6px 10px 10px; border:2px solid #18c37e; transition:transform .18s ease, box-shadow .22s ease, background .2s ease, filter .2s ease; background:linear-gradient(180deg, rgba(24,195,126,.14), rgba(24,195,126,.06)); position:relative; font-size:10px; font-weight:600; transform-style:preserve-3d; }
    .seat label::before{ content:""; position:absolute; top:-8px; width:70%; height:8px; border-radius:6px; background:currentColor; opacity:.15; filter:blur(4px); }
    .seat label::after{ content:""; position:absolute; bottom:-4px; width:60%; height:4px; border-radius:999px; background:#000; opacity:.25; filter:blur(3px); transform: translateZ(-2px); }
    .seat label:hover{ transform:translateY(-1px) translateZ(2px); box-shadow:0 10px 18px rgba(24,195,126,.2); background:linear-gradient(180deg, rgba(24,195,126,.2), rgba(24,195,126,.08)); }
    .seat input:checked + label{ background:linear-gradient(180deg,#22c1ff,#1ea4ff); border-color:#1ea4ff; box-shadow:0 16px 28px rgba(30,164,255,.32); color:#002b3a; transform: translateY(-2px) translateZ(4px); filter: saturate(1.15); }
    .seat input[disabled] + label{ cursor:not-allowed; border-color:#334155; background:rgba(51,65,85,.35); color:rgba(241,245,249,.45); transform: translateZ(0); filter: grayscale(.15); }
    .row.vip .seat label{ border-color:#ffb347; background:linear-gradient(180deg, rgba(255,179,71,.16), rgba(255,179,71,.08)); }
    .row.vip .seat input:checked + label{ background:linear-gradient(180deg,#ffd04d,#ff9f3d); color:#2b1d00; box-shadow:0 12px 22px rgba(255,159,61,.35); }
    .aisle{ width:18px; height:100%; }

    /* Seat grid card */
    .seats-container {
      --seat-size: 48px;
      display: grid;
      grid-template-columns: repeat(10, var(--seat-size));
      gap: 12px;
      justify-content: center;
      padding: 26px 22px;
      margin: 26px auto 12px;
      width: fit-content;
      background: linear-gradient(180deg, rgba(17,24,31,0.95), rgba(14,19,24,0.95));
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.55), inset 0 0 40px rgba(0,188,212,0.04);
    }

    .seat-btn {
      width: var(--seat-size);
      height: var(--seat-size);
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      color: #e6fbff;
      background: linear-gradient(180deg,#1c2a22 0%, #123a24 100%);
      border: 1px solid rgba(0,255,170,0.35);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35);
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease;
    }
    .seat-btn:hover:not(.booked):not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,255,170,0.15); }
    .seat-btn.selected { background: linear-gradient(180deg,#12324f 0%, #0e2540 100%); border-color: rgba(0,170,255,0.45); transform: translateY(-2px); }
    .seat-btn.booked { background: linear-gradient(180deg,#3a1212 0%, #2a0f0f 100%); border-color: rgba(255,80,80,0.55); opacity: .85; cursor: not-allowed; }
    .seat-btn:disabled { cursor: not-allowed; opacity: .6; }

    .legend { display:flex; justify-content:center; gap:22px; margin: 16px 0 10px; flex-wrap: wrap; }
    .legend-item { display:flex; align-items:center; gap:8px; color:#bfe9f0; }
    .legend-item .seat { width: 18px; height: 18px; border-radius:4px; display:inline-block; }
    .seat.available { background: #18c37e; }
    .seat.selected { background: #1ea4ff; }
    .seat.booked { background: #e55050; }
    .seat.vip { background: #ff9f3d; }

    .booking-summary { background: linear-gradient(180deg,#111821,#0d141a); border:1px solid rgba(255,255,255,0.06); padding: 18px; border-radius: 14px; margin-top: 24px; text-align:center; box-shadow: 0 8px 30px rgba(0,0,0,0.35); }
    .summary-details { display:flex; justify-content:space-around; margin-bottom:16px; font-size:1.1rem; color:#dff9fd; }
    .summary-actions { display:flex; gap:14px; justify-content:center; }
    button { padding: 12px 20px; border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 1rem; transition: transform .15s ease, background .2s ease, box-shadow .2s ease; }
    #confirmBtn { background: linear-gradient(180deg,#10c4d9,#0ca7bf); color: #061116; }
    #confirmBtn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(16,196,217,0.25); }
    #confirmBtn:disabled { background: #3b4852; color:#a7b7bf; cursor:not-allowed; transform:none; }
    #resetBtn { background: linear-gradient(180deg,#ffb14d,#ff9800); color: #1b0f00; }
    #resetBtn:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(255,152,0,0.25); }
    #toggle3D { background: linear-gradient(180deg,#b05dd6,#8f35bf); color:#14061b; }
    #toggle3D:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(143,53,191,0.25); }

    /* Modal styles retained */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }

    .modal-content {
      background-color: #2a2a2a;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      width: 50%;
      max-width: 500px;
      position: relative;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: white;
    }

    /* Movie info styles from first code */
    .movie-info {
      text-align: center;
      margin: 20px 0;
      padding: 15px;
      background: #2a2a2a;
      border-radius: 8px;
    }

    .movie-info h2 {
      color: #00bcd4;
      margin-bottom: 10px;
    }
    
    /* 3D MODE */
    body.view-3d .cinema-container { filter: saturate(1.05) contrast(1.02); }
    body.view-3d .screen { transform: rotateX(25deg) translateZ(20px); box-shadow: 0 20px 70px rgba(0, 188, 212, 0.5), 0 0 120px rgba(0, 188, 212, 0.22); }
    body.view-3d .seating { transform: rotateX(38deg) translateY(-8px); filter: drop-shadow(0 30px 40px rgba(0,0,0,.45)); }
    body.view-3d .row:nth-child(1) { transform: translateZ(80px); }
    body.view-3d .row:nth-child(2) { transform: translateZ(64px); }
    body.view-3d .row:nth-child(3) { transform: translateZ(48px); }
    body.view-3d .row:nth-child(4) { transform: translateZ(32px); }
    body.view-3d .row:nth-child(5) { transform: translateZ(16px); }
    body.view-3d .row:nth-child(6) { transform: translateZ(0); }
    body.view-3d .row:nth-child(7) { transform: translateZ(-12px); }
    body.view-3d .row:nth-child(8) { transform: translateZ(-24px); }
    body.view-3d .seats-container { box-shadow: 0 30px 80px rgba(0,0,0,0.65), inset 0 0 60px rgba(0,188,212,0.05); }
    body.view-3d .cinema-container:after { content: ""; position: fixed; left: 0; right: 0; bottom: 0; height: 35vh; background: radial-gradient(80% 60% at 50% 100%, rgba(0,188,212,.08), rgba(0,0,0,.0) 60%); pointer-events: none; }

    /* Responsive 3D adjustments */
    @media (max-width: 640px) {
      body.view-3d .seating { transform: rotateX(36deg) translateY(-4px) scale(.95); }
      body.view-3d .row:nth-child(1) { transform: translateZ(56px); }
      body.view-3d .row:nth-child(2) { transform: translateZ(44px); }
      body.view-3d .row:nth-child(3) { transform: translateZ(32px); }
      body.view-3d .row:nth-child(4) { transform: translateZ(20px); }
    }
  </style>
</head>
<body>
  <!-- Exact UI structure from first code -->
  <div class="cinema-container">
    <header class="cinema-header">
      <h1><%= movie.title %></h1>
      <% if (show && show.theater && show.startTime) { %>
        <p class="show-details">
          <%= show.theater %> | <%= show.startTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %> at <%= show.startTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) %>
        </p>
      <% } else if (show) { %>
        <p class="show-details">
          <%= show.theater || "PVR Cinemas" %> | <%= show.timing || show.showTime || "10:00 AM" %>
        </p>
      <% } %>
      <p class="seat-limit" id="seatLimit" style="display: none;">Select up to <span>0</span> seats</p>
    </header>

    <div class="screen-container">
      <div class="screen"></div>
    </div>

    <!-- Movie info from first code -->
    <div class="movie-info">
      <h2><%= movie.title %></h2>
      <p><%= movie.genre %> | <%= movie.language %> | <%= movie.duration %> mins</p>
    </div>

    <!-- Accessible seating grid A‚ÄìH with 10 seats per row -->
    <div class="seating" id="seatingGrid" role="group" aria-label="Seat rows A to H"></div>
    <div style="width:min(820px,100%);margin:0 auto;height:30px;background:radial-gradient(60% 100% at 50% 0, rgba(255,255,255,.08), transparent 70%);"></div>

    <div class="legend">
      <div class="legend-item"><span class="seat available"></span> Available</div>
      <div class="legend-item"><span class="seat selected"></span> Selected</div>
      <div class="legend-item"><span class="seat booked"></span> Booked</div>
      <div class="legend-item"><span class="seat vip"></span> VIP</div>
    </div>

    <div class="booking-summary">
      <div class="summary-details">
        <p>Selected: <span id="selectedSeats">0</span> Seats</p>
        <p>Total: ‚Çπ<span id="totalCost">0</span></p>
      </div>
      
      <!-- Update the email input section -->
      <div style="margin: 16px 0; text-align: center;">
        <input type="email" 
               id="emailInput" 
               placeholder="Enter email for booking confirmation" 
               style="padding: 10px; border-radius: 8px; border: 1px solid #555; background: #333; color: #fff; width: 300px; max-width: 100%;"
               value="">
      </div>
      
      <div class="summary-actions">
        <button id="resetBtn" type="button">Reset</button>
        <button id="confirmBtn" type="button" disabled>Book Now</button>
        <button id="toggle3D">Toggle 3D Theater View</button>
      </div>
      <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <input id="cancelTicketId" type="text" placeholder="Enter Ticket ID to cancel" style="padding:10px;border-radius:8px;border:1px solid #555;background:#333;color:#fff;min-width:280px;">
        <button id="cancelBookingBtn" type="button" style="background: linear-gradient(180deg,#ff6b6b,#e63946); color:#1b0f00;">Cancel Booking</button>
      </div>
    </div>
  </div>

  <!-- Modal from first code -->
  <div id="seatModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeSeatModal()">&times;</span>
      <h2>Select Number of Seats</h2>
      <div class="carousel-container">
        <div class="carousel-wrapper">
          <div class="carousel" id="carousel"></div>
        </div>
        <button class="carousel-nav prev" onclick="moveCarousel(-1)">&#10094;</button>
        <button class="carousel-nav next" onclick="moveCarousel(1)">&#10095;</button>
      </div>
      <button id="confirmSeatCount" disabled>Confirm</button>
    </div>
  </div>

  <script>
    // All functionality adapted to work with the first code's UI structure
    const seatingGrid = document.getElementById('seatingGrid');
    const selectedSeatsElement = document.getElementById('selectedSeats');
    const totalCostElement = document.getElementById('totalCost');
    const resetBtn = document.getElementById('resetBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const toggle3DBtn = document.getElementById('toggle3D');

    const baseSeatPrice = <%- JSON.stringify(show && show.price ? show.price : 250) %>;


    let selectedSeats = [];
    let bookedSeats = [];

    // Initialize seats and load booked seats
    async function initializeSeats() {
      try {
        // Load already booked seats from backend
        const showId = '<%= show && show._id ? show._id : "" %>';
        if (showId) {
          const response = await fetch(`/seats/booked-seats/${showId}?t=${Date.now()}`, { cache: 'no-store', headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' } });
          const result = await response.json();
          if (result.bookedSeats) {
            bookedSeats = result.bookedSeats;
          }
        }

        generateSeats();
      } catch (error) {
        console.error('Error loading seats:', error);
        generateSeats(); // Generate seats even if API fails
      }
    }

    // Generate rows A‚ÄìH, 10 seats each; G/H VIP
    function generateSeats() {
      seatingGrid.innerHTML = '';
      const rows = ['A','B','C','D','E','F','G','H'];
      for (let r = 0; r < rows.length; r++) {
        const rowEl = document.createElement('div');
        rowEl.className = 'row' + (r >= 6 ? ' vip' : '');
        rowEl.setAttribute('aria-label', `Row ${rows[r]}`);

        const left = document.createElement('div');
        left.className = 'row-label';
        left.textContent = rows[r];
        left.setAttribute('aria-hidden','true');
        rowEl.appendChild(left);

        for (let c = 1; c <= 10; c++) {
          if (c === 6) {
            const aisle = document.createElement('div');
            aisle.className = 'aisle';
            rowEl.appendChild(aisle);
          }
          const seatId = `${rows[r]}${c}`;
          const seatDiv = document.createElement('div');
          seatDiv.className = 'seat' + (r >= 6 ? ' vip' : '');

          const input = document.createElement('input');
          input.type = 'checkbox';
          input.className = 'sr-only';
          input.id = seatId;
          input.dataset.seatNumber = seatId;
          if (bookedSeats.includes(seatId)) input.disabled = true;

          const label = document.createElement('label');
          label.setAttribute('for', seatId);
          label.setAttribute('aria-label', `Row ${rows[r]} seat ${c}${r>=6?' VIP':''}`);
          label.textContent = seatId;

          input.addEventListener('change', () => {
            const idx = selectedSeats.indexOf(seatId);
            if (input.checked) {
              if (idx === -1) selectedSeats.push(seatId);
            } else if (idx > -1) {
              selectedSeats.splice(idx, 1);
            }
            updateSummary();
          });

        seatDiv.appendChild(input);
        seatDiv.appendChild(label);
        rowEl.appendChild(seatDiv);
        }

        const right = document.createElement('div');
        right.className = 'row-label';
        right.textContent = rows[r];
        right.setAttribute('aria-hidden','true');
        rowEl.appendChild(right);

        seatingGrid.appendChild(rowEl);
      }
    }

    function updateSummary() {
      selectedSeatsElement.textContent = selectedSeats.length;
      const totalCost = selectedSeats.length * baseSeatPrice;
      totalCostElement.textContent = totalCost;
      confirmBtn.disabled = selectedSeats.length === 0;
    }

    async function hardResetSelection() {
      try {
        // Force-uncheck ALL seat checkboxes (even if state got desynced)
        const allInputs = seatingGrid.querySelectorAll('input[type="checkbox"]');
        allInputs.forEach(input => { if (!input.disabled) input.checked = false; });
        
        // Clear local selection
        selectedSeats = [];
        updateSummary();
        
        // Reload booked seats from server (handles post-book updates)
        const showId = '<%= show && show._id ? show._id : "" %>';
        if (showId) {
          const res = await fetch(`/seats/booked-seats/${showId}?t=${Date.now()}`, { 
            cache: 'no-store', 
            headers: { 
              'Cache-Control': 'no-cache', 
              'Pragma': 'no-cache' 
            } 
          });
          const data = await res.json();
          bookedSeats = Array.isArray(data.bookedSeats) ? data.bookedSeats : [];
        }
        
        // Rebuild grid from scratch
        seatingGrid.innerHTML = '';
        generateSeats();
      } catch (e) {
        console.error('Reset reload failed:', e);
        // Fallback: just regenerate
        selectedSeats = [];
        seatingGrid.innerHTML = '';
        generateSeats();
      } finally {
        // Update UI counters and button
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Book Now';
        selectedSeatsElement.textContent = '0';
        totalCostElement.textContent = '0';
        // Phone input ko bhi clear kar do
        const emailInput = document.getElementById('emailInput');
        if (emailInput) emailInput.value = '';
        if (document.activeElement === resetBtn) resetBtn.blur();
      }
    }

    resetBtn.addEventListener('click', hardResetSelection);

    // 3D Toggle functionality
    toggle3DBtn.addEventListener('click', () => {
      document.body.classList.toggle('view-3d');
      toggle3DBtn.textContent = document.body.classList.contains('view-3d') ? 'Disable 3D Theater View' : 'Enable 3D Theater View';
    });

    // Update the confirm button handler
    confirmBtn.addEventListener('click', async () => {
      if (selectedSeats.length > 0) {
        try {
          const showId = '<%= show && show._id ? show._id : "" %>';
          const emailInput = document.getElementById('emailInput');
          let userEmail = emailInput.value.trim();
          
          if (!showId) {
            alert('‚ùå Error: Show information not found');
            return;
          }

          if (!userEmail) {
            alert('üìß Please enter your email to receive booking confirmation');
            emailInput.focus();
            return;
          }

          // Validate email format
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(userEmail)) {
            alert('Please enter a valid email address');
            emailInput.focus();
            return;
          }

          confirmBtn.disabled = true;
          confirmBtn.textContent = 'Booking...';

          const response = await fetch('/seats/book', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              showId: showId,
              seats: selectedSeats,
              userEmail: userEmail
            })
          });

          const result = await response.json();
          
          if (result.success) {
            // Display booking confirmation with proper email status
            const emailStatusText = result.emailStatus || 'üìß Processing confirmation email...';
            alert(`‚úÖ Booking Successful!\nüé´ Ticket ID: ${result.ticketId}\nüí∞ Total: ‚Çπ${result.totalAmount}\n${emailStatusText}`);
            
            // Save email in localStorage for future use
            localStorage.setItem('lastUsedEmail', userEmail);
            selectedSeats = [];
            await hardResetSelection();
          } else {
            alert('‚ùå Booking failed: ' + result.error);
          }
        } catch (error) {
          console.error('Booking error:', error);
          alert('‚ùå Network error! Please check your connection and try again.');
        } finally {
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Book Now';
        }
      }
    });

    // Add this to restore last used email
    window.addEventListener('DOMContentLoaded', () => {
      const emailInput = document.getElementById('emailInput');
      const lastUsedEmail = localStorage.getItem('lastUsedEmail');
      if (lastUsedEmail) {
        emailInput.value = lastUsedEmail;
      }
    });

    // Cancel booking handler
    document.getElementById('cancelBookingBtn').addEventListener('click', async () => {
      const ticketId = document.getElementById('cancelTicketId').value.trim();
      if (!ticketId) {
        alert('Please enter a Ticket ID to cancel.');
        return;
      }
      try {
        const resp = await fetch('/seats/cancel-booking', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticketId })
        });
        const data = await resp.json();
        if (data.success) {
          alert('‚úÖ ' + data.message);
          document.getElementById('cancelTicketId').value = '';
          await hardResetSelection();
        } else {
          alert('‚ùå ' + (data.error || 'Failed to cancel booking'));
        }
      } catch (e) {
        console.error('Cancel booking error:', e);
        alert('‚ùå Network error while cancelling booking');
      }
    });

    // Modal functions
    function closeSeatModal() {
      document.getElementById('seatModal').style.display = 'none';
    }

    function moveCarousel(direction) {
      console.log('Carousel moved:', direction);
    }

    // Initialize the seat layout
    initializeSeats();
  </script>
</body>
</html>